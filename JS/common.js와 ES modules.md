# CommonJS와 ES 모듈 비교

JavaScript에 공식적이고 표준화된 모듈 시스템을 가져오는 ES 모듈이 드디어 등장했습니다. 이를 위해 거의 10년간의 표준화 작업이 필요했지만, 이제 곧 모든 주요 브라우저에서 ES 모듈을 지원하게 됩니다. Firefox 60이 5월에 출시되면(현재 베타 버전), 모든 주요 브라우저가 ES 모듈을 지원하게 되며, Node.js에서도 ES 모듈 지원을 추가하기 위해 Node 모듈 작업 그룹이 열심히 작업 중입니다. 또한 WebAssembly와의 ES 모듈 통합도 진행 중입니다.

많은 JavaScript 개발자들은 ES 모듈이 논란이 많았다는 것을 알고 있습니다. 하지만 실제로 ES 모듈이 어떻게 작동하는지 이해하는 사람은 많지 않습니다. 이제 ES 모듈이 해결하는 문제와 다른 모듈 시스템과 어떻게 다른지 살펴보겠습니다.

## 모듈이 해결하는 문제는 무엇인가요?

JavaScript로 코딩하는 것은 변수 관리를 중심으로 이루어집니다. 변수에 값을 할당하거나, 변수에 숫자를 더하거나, 두 변수를 결합하여 다른 변수에 넣는 것이 대부분입니다. 이렇게 변수 변경이 대부분인 코드는 변수들을 어떻게 조직하느냐에 따라 코드 작성 및 유지 관리에 큰 영향을 미칩니다.

함수는 정의된 다른 함수의 변수를 접근할 수 없습니다. 이는 각 함수가 독립적으로 동작할 수 있도록 하여 코드를 유지보수하기 쉽게 만듭니다. 하지만 함수 간에 변수를 공유하려면 글로벌 스코프를 사용해야 했습니다. 이는 코드 유지 관리에 여러 문제를 야기합니다.

### 모듈의 장점

모듈은 관련 있는 변수와 함수들을 하나의 모듈 스코프 내에 그룹화하여 변수를 조직하고 공유하는 더 나은 방법을 제공합니다. 모듈 스코프는 함수 스코프와 달리, 다른 모듈과 변수를 명시적으로 공유할 수 있습니다. 이 과정을 내보내기(export)라고 하며, 다른 모듈은 이를 명시적으로 가져오기(import)하여 사용합니다. 이 명시적인 관계 덕분에, 어떤 모듈이 다른 모듈에 의존하는지 쉽게 알 수 있어 코드 유지 보수가 용이해집니다.

## CommonJS와 ES 모듈 비교

### CommonJS

CommonJS(CJS)는 Node.js에서 역사적으로 사용된 모듈 시스템입니다. CJS에서는 모듈과 그 하위 의존성이 모두 한 번에 로드, 인스턴스화, 평가됩니다. CJS 모듈은 파일 시스템에서 파일을 로드하기 때문에, 로드 과정에서 메인 스레드를 차단해도 문제가 없습니다. 따라서 CJS는 동기적으로 작동하며, `require` 문을 통해 모듈을 가져옵니다.

### ES 모듈

ES 모듈(ESM)은 JavaScript 사양에 추가된 새로운 모듈 시스템입니다. ESM은 비동기적으로 동작하며, 로드, 인스턴스화, 평가 단계를 분리하여 처리합니다. 이로 인해 브라우저는 모듈 파일을 비동기적으로 가져와도 성능에 영향을 주지 않습니다. ESM은 `import`와 `export` 문을 통해 모듈을 가져오고 내보냅니다.

### 주요 차이점

- **비동기성**: ES 모듈은 로드, 인스턴스화, 평가 단계를 비동기적으로 처리할 수 있습니다. 반면, CommonJS는 모든 단계를 동기적으로 처리합니다.
- **라이브 바인딩**: ES 모듈은 라이브 바인딩을 사용하여 모듈 간의 값을 실시간으로 동기화합니다. CommonJS는 값을 복사하여 전달하므로, 값이 변경되면 가져온 모듈에서는 이를 반영하지 않습니다.
- **모듈 스펙**: ES 모듈은 모듈 파일을 파싱하여 모듈 레코드를 생성하고, 이를 인스턴스화하여 메모리에 변수를 할당한 후, 코드를 평가하여 값을 채웁니다. CommonJS는 모듈을 로드하는 즉시 코드를 실행하여 값을 평가합니다.

## ES 모듈의 작동 방식

ES 모듈은 모듈 의존성 그래프를 구성하여 작동합니다. 브라우저나 Node는 `import` 문을 통해 어떤 코드를 로드해야 하는지 알게 됩니다. 이 과정은 세 단계로 나뉩니다:

1. **구성**: 파일을 찾아 다운로드하고, 이를 모듈 레코드로 파싱합니다.
2. **인스턴스화**: 메모리에 변수의 상자를 할당하고, 내보내기와 가져오기를 연결합니다.
3. **평가**: 코드를 실행하여 메모리 상자에 실제 값을 채웁니다.

이 과정에서 모듈 로더는 모듈을 캐싱하여 중복 로드를 방지합니다. 또한, ES 모듈은 사이클 종속성을 지원하여 복잡한 모듈 그래프에서도 문제없이 동작합니다.

## 결론

ES 모듈은 JavaScript에 표준화된 모듈 시스템을 도입하여 코드 조직과 재사용성을 향상시킵니다. 모든 주요 브라우저에서 지원하며, Node.js에서도 지원이 추가될 예정입니다. CommonJS와 비교하여 비동기적 처리와 라이브 바인딩 등의 이점을 제공하며, 앞으로 더 많은 모듈 기능이 추가될 예정입니다.
